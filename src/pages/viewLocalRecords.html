<!DOCTYPE html>
<!--
    !!!!! "Template" this page to match other "utility" pages !!!!!
-->
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>View local records</title>
        <style>
            #myTable { border-collapse:collapse; }
            #myTable th { border: 1px solid black; padding:5px; }
            #myTable td { border: 1px solid black; padding:5px; }
        </style>
        <script src="/LastMileData/lib/jquery.min.js"></script>
        <script>
        
        // modify to aggregate
        
        $(document).ready(function(){
            window.webkitStorageInfo.requestQuota(PERSISTENT, 50*1024*1024, function(grantedBytes) {
                window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                window.requestFileSystem(PERSISTENT, grantedBytes,
                    // Success handler
                    function(fs) {
                        // Read in file
                        fs.root.getFile('data.lmd', {}, function(fileEntry) {
                            // Get a File object representing the file, then use FileReader to read its contents.
                            fileEntry.file(function(file) {
                                var reader = new FileReader();
                                reader.onloadend = function(e) {
                                    if (this.result == "" || this.result == "{}") {
                                        $('#myFileDiv').append('No records.');
                                    }
                                    else {
                                        // Otherwise, parse myRecordset into object
                                        myRecordset = JSON.parse(this.result);

                                        // First loop through keys of myRecordset (set numRecords and manipulate DOM)
                                        for (rKey in myRecordset) {
                                            try {
                                                // Assign record object to currentRecord
                                                currentRecord = JSON.parse(myRecordset[rKey]);
                                            }
                                            catch(e) {
                                                currentRecord = 1;  // To avoid JSON.Parse() returning an error if value variable is not valid JSON
                                            }
                                            
                                            // Test to see if current localStorage record is of type "form"
                                            if (currentRecord.type == "form") {
                                                addRow(currentRecord);
                                            }
                                        }

                                        // Second loop through keys of myRecordset (process numRecords)
                                        for (rKey in myRecordset) {

                                            try {
                                                // Assign record object to currentRecord
                                                currentRecord = JSON.parse(myRecordset[rKey]);
                                            }
                                            catch(e) {
                                                currentRecord = 1;  // To avoid JSON.Parse() returning an error if value variable is not valid JSON
                                            }

                                            // Test to see if current localStorage record is of type "form"
                                            if (currentRecord.type == "form") {
                                                // code here
                                            }

                                        }
                                    }
                                };
                                reader.readAsText(file);
                            }, logError);
                        }, logError);
                    }, logError);
            });
        });
        
        
        function logError(e) {
            // Use "closures"; see http://www.howtocreate.co.uk/referencedvariables.html
            if (e.name == 'NotFoundError') {
                console.log('Caught error -- no records ever submitted');
                noRecordsMessage();
            }
            else {
                console.log('deqa - logError');
                console.log(e);
            }
        }
        
        
        function addRow(currentRecord) {
            // !!!!! add primary keys here !!!!!
            // !!!!! figure out a way to DRY-assign a field as a primary key; refactor into QA code !!!!!
            var row = '<tr><td>' + currentRecord.table + '</td>';
            row += '<td>' + currentRecord.de_date + '</td>';
            row += '<td>' + currentRecord.de_init + '</td>';
            row += '<td>' + currentRecord.qa_date + '</td>';
            row += '<td>' + currentRecord.qa_init + '</td></tr>';
            $('#myTable').append(row);
        }
        </script>
    </head>
    <body>
        <table id="myTable">
            <tr>
                <th>Table name</th>
                <th>DE Date</th>
                <th>DE Initials</th>
                <th>QA Date</th>
                <th>QA Initials</th>
            </tr>
        </table>
        <br>
        <a href="/LastMileData/src/pages/page_deqa.html">Return to DEQA page.</a>
    </body>
</html>
