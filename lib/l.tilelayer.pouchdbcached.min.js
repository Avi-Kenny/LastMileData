// https://github.com/MazeMap/Leaflet.TileLayer.PouchDBCached
L.TileLayer.addInitHook(function(){return this.options.useCache?(this._db=new PouchDB("offline-tiles"),this._canvas=document.createElement("canvas"),void(this._canvas.getContext&&this._canvas.getContext("2d")||(this._canvas=null))):(this._db=null,void(this._canvas=null))}),L.TileLayer.prototype.options.useCache=!1,L.TileLayer.prototype.options.saveToCache=!0,L.TileLayer.prototype.options.useOnlyCache=!1,L.TileLayer.prototype.options.cacheFormat="image/png",L.TileLayer.prototype.options.cacheMaxAge=864e5,L.TileLayer.include({createTile:function(a,b){var c=document.createElement("img");c.onerror=L.bind(this._tileOnError,this,b,c),this.options.crossOrigin&&(c.crossOrigin=""),c.alt="";var d=this.getTileUrl(a);return this.options.useCache&&this._canvas?this._db.get(d,{revs_info:!0},this._onCacheLookup(c,d,b)):c.onload=L.bind(this._tileOnLoad,this,b,c),c.src=d,c},_onCacheLookup:function(a,b,c){return function(d,e){e?(this.fire("tilecachehit",{tile:a,url:b}),Date.now()>e.timestamp+this.options.cacheMaxAge&&!this.options.useOnlyCache?(this.options.saveToCache&&(a.onload=L.bind(this._saveTile,this,a,b,e._revs_info[0].rev,c)),a.crossOrigin="Anonymous",a.src=b,a.onerror=function(a){this.src=e.dataUrl}):(a.onload=L.bind(this._tileOnLoad,this,c,a),a.src=e.dataUrl)):(this.fire("tilecachemiss",{tile:a,url:b}),this.options.useOnlyCache?(a.onload=L.Util.falseFn,a.src=L.Util.emptyImageUrl):(this.options.saveToCache?a.onload=L.bind(this._saveTile,this,a,b,null,c):a.onload=L.bind(this._tileOnLoad,this,c,a),a.crossOrigin="Anonymous",a.src=b))}.bind(this)},_saveTile:function(a,b,c,d){if(null!==this._canvas){this._canvas.width=a.naturalWidth||a.width,this._canvas.height=a.naturalHeight||a.height;var e=this._canvas.getContext("2d");e.drawImage(a,0,0);var f;try{f=this._canvas.toDataURL(this.options.cacheFormat)}catch(b){return this.fire("tilecacheerror",{tile:a,error:b}),d()}var g={dataUrl:f,timestamp:Date.now()};c&&this._db.remove(b,c),this._db.put(g,b,g.timestamp),d&&d()}},seed:function(a,b,c){if(this.options.useCache&&!(b>c)&&this._map){for(var d=[],e=b;e<=c;e++)for(var f=this._map.project(a.getNorthEast(),e),g=this._map.project(a.getSouthWest(),e),h=this.getTileSize(),i=L.bounds(L.point(Math.floor(f.x/h.x),Math.floor(f.y/h.y)),L.point(Math.floor(g.x/h.x),Math.floor(g.y/h.y))),j=i.min.y;j<=i.max.y;j++)for(var k=i.min.x;k<=i.max.x;k++)point=new L.Point(k,j),point.z=e,d.push(this._getTileUrl(point));var l={bbox:a,minZoom:b,maxZoom:c,queueLength:d.length};this.fire("seedstart",l);var m=this._createTile();m._layer=this,this._seedOneTile(m,d,l)}},_createTile:function(){return document.createElement("img")},_getTileUrl:function(a){var b=a.z;return this.options.zoomReverse&&(b=this.options.maxZoom-b),b+=this.options.zoomOffset,L.Util.template(this._url,L.extend({r:this.options.detectRetina&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),x:a.x,y:this.options.tms?this._globalTileRange.max.y-a.y:a.y,z:this.options.maxNativeZoom?Math.min(b,this.options.maxNativeZoom):b},this.options))},_seedOneTile:function(a,b,c){if(!b.length)return void this.fire("seedend",c);this.fire("seedprogress",{bbox:c.bbox,minZoom:c.minZoom,maxZoom:c.maxZoom,queueLength:c.queueLength,remainingLength:b.length});var d=b.pop();this._db.get(d,function(e,f){f?this._seedOneTile(a,b,c):(a.onload=function(e){this._saveTile(a,d,null),this._seedOneTile(a,b,c)}.bind(this),a.crossOrigin="Anonymous",a.src=d)}.bind(this))}});