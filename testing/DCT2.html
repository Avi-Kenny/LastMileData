<!DOCTYPE html>

<html>
    
    <head>
        
        <title>DCT Data Tool</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <meta name='robots' content='noindex'>
        <script src="/LastMileData/lib/jquery.min.js"></script>
        <script src="/LastMileData/lib/jquery-ui-1.11.1/jquery-ui.min.js"></script>
        <script src="/LastMileData/lib/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/LastMileData/lib/bootstrap-3.2.0-dist/css/bootstrap.min.css"  type="text/css" />
        <link rel="stylesheet" href="/LastMileData/lib/bootstrap-3.2.0-dist/css/bootstrap-theme.min.css"  type="text/css" />
        <link rel="stylesheet" href="/LastMileData/lib/jquery-ui-1.11.1/jquery-ui.min.css"  type="text/css" />
        
        <style>
            
            table, th, td { border: 1px solid black; padding: 3px; }
            
            td { min-width:200px; }
            
            hr { border: 1px solid black; }
            
            body {
                font-size:16px;
                font-weight:bold;
            }
            
            #myDiv {
                position:relative;
                background-color:white;
                margin:auto;
                padding:3px;
            }
            
        </style>
        
        <script>
        $(document).ready(function(){
            
            function mysql_date(inputDate) {
                if (arguments.length === 0) {
                    var myDate = new Date();
                } else {
                    var myDate = new Date(inputDate);
                }
                return ( myDate.getUTCFullYear() + "-" + twoDigits(1 + myDate.getUTCMonth()) + "-" + twoDigits(myDate.getUTCDate()) );
            }
            function twoDigits(d) {
                if(0 <= d && d < 10) return "0" + d.toString();
                if(-10 < d && d < 0) return "-0" + (-1*d).toString();
                return d.toString();
            }
            
            
            
            $('#uploadODK').click(function(){
                
                // Get fileinput
                var myInput = document.getElementById('modal_uploadODK_fileInput');
                
                // Loop through files
                for(var i = 0; i < myInput.files.length ; i++) {
                    (function(i){
                        var file = myInput.files[i];
                        var reader = new FileReader();
                        reader.onload = function() {
                            
                            // Get string; parse into XML object
                            var filecontent = reader.result;
                            var myJQXML = $.parseXML(filecontent);
                            var $myJQXML = $(myJQXML);
                            
                            var j = 1;
                            extractODK($myJQXML);
                            
                            function extractODK($XML) {
                                
                                var fieldName, fieldType, modText;
                                
                                $XML.each(function(){
                                    if ($XML.children().length === 0 && $XML.prop("tagName").substr(0,4) === "LMD-") {
                                        $('#temp').append(j + ")<br>");
                                        fieldName = $XML.prop("tagName").substr(8);
                                        $('#temp').append('fieldName: ' + fieldName + "<br>");
                                        fieldType = $XML.prop("tagName").substr(4,3);
                                        $('#temp').append('fieldType: ' + fieldType + "<br>");
                                        
                                        if (fieldType === 'TAB') {
                                            modText = 'table: ' + $XML.text();
                                        } else if (fieldType === 'VAL') {
                                            modText = fieldName + ': ' + $XML.text();
                                        } else if (fieldType === 'TIM') {
                                            var myMySQLTime = $XML.text().substr(0,$XML.text().indexOf("."));
                                            modText = fieldName + ': ' + myMySQLTime;
                                        } else if (fieldType === 'DAT') { // !!!!! use utility functions in fhwForms.js !!!!!
                                            var myDate = new Date(86400000*Math.floor($XML.text()));
                                            var myMySQLDate = myDate.getUTCFullYear() + "-" + 1 + myDate.getUTCMonth() + "-" + myDate.getUTCDate();
                                            modText = fieldName + ': ' + myMySQLDate;
                                        } else {
                                            modText = 'error';
                                        }
                                        
                                        $('#temp').append(modText);
                                        $('#temp').append("<br><br><hr>");
                                        j++;
                                    } else {
                                        $XML.children().each(function(){
                                            extractODK($(this));
                                        });
                                    }
                                });
                            }
                            
                        }
                        reader.readAsText(file);
                    })(i);
                }
                
            });
            
            
            $('#uploadB').click(function(){
                
                // Choose SCF or SST
                whichForm = $('input[name=whichForm]:checked').val();
                switch (whichForm) {
                    case 'SUP':
                        var nodeArray = ['ODK-FHW_ID','ODK-Date','ODK-FHW_Present','ODK-ExcusedAbsence','ODK-WarningLetter','ODK-Probation','ODK-Termination','Number_of_Births','Number_of_Deaths','Number_of_Movements','Number_of_Big_Bellies','Number_of_Infants','HomeVisits','ODK-RV_Ebola_Score','ODK-BigBelly','ODK-ICCM_Score','ODK-InfantTracking_Score','ODK-WellChild_Score','ODK-FamilyPlanning_Score','ODK-WellAdult_Score','ODK-BirthsInMonth','ODK-NumberOfBirths','ODK-HomeBirths','ODK-FacilityBirths','ODK-NoANCVisits','ODK-1to3ANCVisits','ODK-4OrMoreANCVisits','ODK-CheckIn_Completed','ODK-CAP_Completed','ODK-NumberofCHCMeetings','ODK-NumberOfCommunityMeetings','ODK-NumberOfBigBellies','ODK-NumberOfInfants','ODK-NumberOfDeaths','ODK-AuditDate','ODK-Visit_Type','ODK-Audit_MemberID','ODK-AuditCorrectTreatment','ODK-RestockWeek'];
                        var formName = 'FHW Supervision Report';
                        break;
                    case 'DCL':
                        var nodeArray = ['ODK-PlateNumber','ODK-Date','ODK-SupervisionSupplies','ODK-MotorbikeCheck1','ODK-MotorbikeCheck2','ODK-fuelfilled','ODK-Fuel_Ammt','ODK-TimeOfDeparture'];
                        var formName = 'Departure Check Log';
                        break;
                    case 'ACL':
                        var nodeArray = ['ODK-TimeOfArrival','ODK-Date','ODK-KmTraveled','ODK-FieldEmergencies','ODK-Maintenance'];
                        var formName = 'Arrival Check Log';
                        break;
                    case 'RES':
                        var nodeArray = ['ODK-FHWID','ODK-Date','ODK-Population','ODK-ACT_25mg','ODK-Restock_ACT_25mg','ODK-ACT_25mg_OOS','ODK-ACT25mg_Reason','ODK-ACT_25mg_RestockAmt','ODK-ACT_50mg','ODK-Restock_ACT_50mg','ODK-ACT_50mg_OOS','ODK-ACT50mg_Reason','ODK-ACT_50mg_RestockAmt','ODK-Restock_ACT_Split100mg','ODK-ACT_Split100mg_OOS','ODK-SplitACT100mg_Reason','ODK-ACT_100mg','ODK-Restock_ACT_100mg','ODK-ACT_100mg_OOS','ODK-ACT100mg_Reason','ODK-ACT_100mg_RestockAmt','ODK-MRDT','ODK-Restock_MRDT','ODK-MRDT_OOS','ODK-MRDT_Reason','ODK-MRDT_RestockAmt','ODK-Paracetamol_Child','ODK-Restock_Paracetamol_Child','ODK-Paracetamol_Child_OOS','ODK-Paracetamol_Child_Reason','ODK-Paracetamol_Child_RestockAmt','ODK-Paracetamol_Adult','ODK-Restock_Paracetamol_Adult','ODK-Paracetamol_Adult_OOS','ODK-Paracetamol_Adult_Reason','ODK-Paracetamol_Adult_RestockAmt','ODK-ORS','ODK-Restock_ORS','ODK-ORS_OOS','ODK-ORS_Reason','ODK-ORS_RestockAmt','ODK-Zinc','ODK-Restock_Zinc','ODK-Zinc_OOS','ODK-Zinc_Reason','ODK-Zinc_RestockAmt','ODK-Amoxicillin','ODK-Restock_Amoxicillin','ODK-Amoxicillin_OOS','ODK-Amoxicillin_Reason','ODK-Amoxicillin_RestockAmt','ODK-OCP','ODK-Restock_OCP','ODK-OCP_OOS','ODK-OCP_Reason','ODK-OCP_RestockAmt','ODK-Condoms','ODK-Restock_Condoms','ODK-Condoms_OOS','ODK-Condoms_Reason','ODK-Condoms_RestockAmt','ODK-MTT','ODK-Restock_MTT','ODK-MTT_OOS','ODK-MTT_Reason','ODK-MTT_RestockAmt','ODK-MosquitoNets','ODK-Restock_MosquitoNets','ODK-MosquitoNets_OOS','ODK-MosquitoNets_Reason','ODK-MosquitoNets_RestockAmt','ODK-Mebendazole','ODK-Restock_Mebendazole','ODK-Mebendazole_OOS','ODK-Mebendazole_Reason','ODK-Mebendazole_RestockAmt','ODK-MuacStrap','Restock_Muac','ODK-Chlorhexadine','question7','ODK-StopwatchBatteries','Restock_Batteries','ODK-Gloves','ODK-Restock_Gloves','ODK-Gloves_OOS','ODK-Gloves_Reason','ODK-Gloves_RestockAmt','ODK-Bags','ODK-Restock_Bags','ODK-Bags_OOS','ODK-Bags_Reason','ODK-Bags_RestockAmt','ODK-Cotton','ODK-Bags_Reason','ODK-Cotton_RestockAmt','ODK-Markers','NoMarkers','ODK-ScreeningTool','NoScreeningTool','ODK-DoseCard','question12','ODK-RoutineVisit','ODK-Restock_RoutineVisit','ODK-RoutineVisit_OOS','ODK-RoutineVisit_Reason','ODK-RoutineVisit_RestockAmt','ODK-SicknessScreening','ODK-Restock_SicknessScreening','ODK-SicknessScreening_OOS','ODK-SicknessScreening_Reason','ODK-SicknessScreening_RestockAmt','ODK-SickChild','ODK-Restock_SickChild','ODK-SickChild_OOS','ODK-SickChild_Reason','ODK-SickChild_RestockAmt','ODK-MalariaForms','ODK-Restock_MalariaForms','ODK-MalariaForms_OOS','ODK-MalariaForms_Reason','ODK-MalariaForms_RestockAmt','ODK-PregnancyTracking','ODK-Restock_PregnancyTracking','ODK-PregnancyTracking_OOS','ODK-PregnancyTracking_Reason','ODK-PregnacyTracking_RestockAmt','ODK-MOH','ODK-Restock_MOH','ODK-MOH_OOS','ODK-MOH_Reason','ODK-MOH_RestockAmt','ODK-Movement','ODK-Restock_Movement','ODK-Movement_OOS','ODK-Movement_Reason','ODK-Movement_RestockAmt','ODK-ScreeningLedger','ODK-Restock_ScreeningLedger','ODK-ScreeningLedger_OOS','ODK-ScreeningLedger_Reason','ODK-ScreeningLedger_RestockAmt','ODK-FamilyPlanning','ODK-Restock_FamilyPlanning','ODK-FamilyPlanning_OOS','ODK-FamilyPlanning_Reason','ODK-FamilyPlanning_RestockAmt','ODK-InfantTracking','ODK-Restock_InfantTracking','ODK-InfantTracking_OOS','ODK-InfantTracking_Reason','ODK-InfantTracking_RestockAmt','ODK-WellChild','ODK-Restock_WellChild','ODK-WellChild_OOS','ODK-WellChild_Reason','ODK-WellChild_RestockAmt'];
                        var formName = 'FHW Restock';
                        break;
                    case 'SST':
                        var nodeArray = ['question1','question2','question3','question4','question5','question6','question7','question8','question9','question10','Outcome1','Outcome2','Outcome3','Outcome4','Outcome5','Outcome6'];
                        var formName = 'FHW: Sickness Screening Tool';
                        break;
                    case 'SCH':
                        var nodeArray = ['ODK-visit_type','ODK-VillageID_No','ODK-MemberID_No','ODK-MemberID_Validation','ODK-PatientName','ODK-VisitNumber','ODK-ChildAge','ODK-AgeErrorYoung','ODK-AgeErrorOld','UnderAge','ODK-Source','ODK-Coughing','ODK-DaysCoughing','ODK-Fever','ODK-DaysFever','ODK-Diarrhea','ODK-DaysDiarrhea','ODK-BloodInStool','ODK-Convulsions','ODK-ProblemDrinkingFeeding','ODK-EatDrinkAnything','ODK-Vomiting','ODK-VomitingEverything','ODK-ChestIndrawing','ODK-BPM1','FastBreathing1','ODK-BPM2','FastBreathing2','ODK-Unconscious','ODK-FeetSwelling','Cough','Fever','Diarrhea','Blood_in_stool','Convulsions','Unable_to_Eat_Anything','Vomiting_Everything','Chest_Indrawing','Sleepy_or_Unconcious','Feet_Swelling','Refer_Patient','Treat_Patient','FollowUp_Referral','ODK-DiarrheaTreatment1','ODK-DiarrheaTreatment2','ODK-DiarrheaTreatment3','ODK-Treatment_Fever1','ODK-Referral_Information1','ODK-Referral_Diarrhea1','ODK-Referral_Fever_1','ODK-Referral_Fever2','ODK-Referral_Fever_3','ODK-Referral_ChestIndrawing1','ODK-FollowUp_DangerSigns','ODK-FollowUp_Refer','ODK-FollowUp_Improvement','ODK-FollowUp_Refer2','ODK-Untreatable_Problem','ODK-Untreatable_Referral','ODK-NextDayFollowUp'];
                        var formName = 'FHW: Sick Child Form';
                        break;
                }
                
                // Create table headers
                var $myTable = $('#myTable');
                var myRow = "<tr>";
                for (j in nodeArray) {
                    myRow += "<th>" + nodeArray[j] + "</th>";
                }
                myRow += "</tr>";
                $myTable.append(myRow);
                
                // Get fileinput
                var myInput = document.getElementById('modal_uploadODK_fileInput');
                
                for(var i = 0; i < myInput.files.length ; i++) {
                    (function(i){
                        var file = myInput.files[i];
                        var reader = new FileReader();
                        reader.onload = function() {
                            
                            // Get string; parse into XML object
                            var filecontent = reader.result;
                            var myJQXML = $.parseXML(filecontent);
                            var $myJQXML = $(myJQXML);
                            
                            // Filter data; only display SUP, SCH, or SST forms
                            if ( $myJQXML.find('data').attr('name') === formName ) {
                                
                                // Create table rows
                                myRow = "<tr>";
                                for (j in nodeArray) {
                                    myRow += "<td>" + $myJQXML.find(nodeArray[j]).text() + "</td>";
                                }
                                myRow += "</tr>";
                                $myTable.append(myRow);
                                
                            }
                            
                        }
                        reader.readAsText(file);
                    })(i);
                }

            });
            
            $('#downloadB').click(function(){
                
                var tableContents = $('#tableContents').html();
                
                // Construct the download link and programmatically click the link
                var textToWrite = tableContents;
                var textFileAsBlob = new Blob([textToWrite], {type: 'text/plain'});
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                var yyyy = today.getFullYear();
                var fileNameToSaveAs = "data_" + yyyy + "-" + mm + "-" + dd + ".xls"; // !!!!! make this a proper MySQL date (two digits for day and month) !!!!!
                var downloadLink = document.createElement("a");
                downloadLink.download = fileNameToSaveAs;
                downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
                downloadLink.click();
                
            });
            
        });
        </script>
        
    </head>
    
    <body id="myBody">
        
        <div id="myDiv">
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="SUP">SUP</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="DCL">DCL</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="ACL">ACL</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="RES">RES</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="SCH">SCH</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="SST">SST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
            <div style="float:left"><input id="modal_uploadODK_fileInput" type='file' multiple></div>
            <div style="float:left"><button id="uploadB" style="width:200px">Upload</button>&nbsp;&nbsp;</div>
            <div style="float:left"><button id="uploadODK" style="width:200px">Upload ODK</button>&nbsp;&nbsp;</div>
            <div style="float:left"><button id="downloadB" style="width:200px">Download as XLS</button></div>
            <br><hr>
            <div id="tableContents">
                <table><tbody id='myTable'></tbody></table>                
            </div>
            <div id="temp"></div>
        </div>
        
        
    </body>
    
</html>