<!DOCTYPE html>

<html>
    
    <head>
        
        <title>DCT Data Tool</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <meta name='robots' content='noindex'>
        <script src="/LastMileData/lib/jquery.min.js"></script>
        <script src="/LastMileData/lib/jquery-ui-1.11.1/jquery-ui.min.js"></script>
        <script src="/LastMileData/lib/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/LastMileData/lib/bootstrap-3.2.0-dist/css/bootstrap.min.css"  type="text/css" />
        <link rel="stylesheet" href="/LastMileData/lib/bootstrap-3.2.0-dist/css/bootstrap-theme.min.css"  type="text/css" />
        <link rel="stylesheet" href="/LastMileData/lib/jquery-ui-1.11.1/jquery-ui.min.css"  type="text/css" />
        
        <style>
            
            table, th, td { border: 1px solid black; padding: 3px; }
            
            td { min-width:200px; }
            
            hr { border: 1px solid black; }
            
            body {
                font-size:16px;
                font-weight:bold;
            }
            
            #myDiv {
                position:relative;
                background-color:white;
                margin:auto;
                padding:3px;
            }
            
        </style>
        
        <script>
        $(document).ready(function(){
            
            $('#uploadODK').click(function(){
                
                // Get fileinput
                var myInput = document.getElementById('uploadInput');
                
                // Loop through files
                for(var i = 0; i < myInput.files.length ; i++) {
                    (function(i){
                        var file = myInput.files[i];
                        var reader = new FileReader();
                        reader.onload = function() {
                            
                            // Get string; parse into XML object
                            var filecontent = reader.result;
                            var myJQXML = $.parseXML(filecontent);
                            var $myJQXML = $(myJQXML);
                            
                            var j = 1;
                            extractODK($myJQXML);
                            
                            function extractODK($XML) {
                                console.log($XML);
                                $XML.each(function(){
//                                    if ($XML.children().length === 0) {
                                    if ($XML.children().length === 0 && $XML.prop("tagName").substr(0,4) === "ODK-") {
                                        $('#temp').append(j + ")<br>");
                                        $('#temp').append($XML.prop("tagName").substr(4) + "<br>");
                                        $('#temp').append($XML.text());
                                        $('#temp').append("<br><br><hr>");
                                        j++;
                                    } else {
                                        $XML.children().each(function(){
                                            extractODK($(this));
                                        });
                                    }
                                });
                            }
                            
                        }
                        reader.readAsText(file);
                    })(i);
                }
                
            });
            
            
            $('#uploadB').click(function(){
                
                // Choose SCF or SST
                whichForm = $('input[name=whichForm]:checked').val();
                switch (whichForm) {
                    case 'SST':
                        var nodeArray = ['question1','question2','question3','question4','question5','question6','question7','question8','question9','question10','Outcome1','Outcome2','Outcome3','Outcome4','Outcome5','Outcome6'];
                        var formName = 'FHW: Sickness Screening Tool';
                        break;
                    case 'SCH':
                        var nodeArray = ['ODK-visit_type','ODK-VillageID_No','ODK-MemberID_No','ODK-MemberID_Validation','ODK-PatientName','ODK-VisitNumber','ODK-ChildAge','ODK-AgeErrorYoung','ODK-AgeErrorOld','UnderAge','ODK-Source','ODK-Coughing','ODK-DaysCoughing','ODK-Fever','ODK-DaysFever','ODK-Diarrhea','ODK-DaysDiarrhea','ODK-BloodInStool','ODK-Convulsions','ODK-ProblemDrinkingFeeding','ODK-EatDrinkAnything','ODK-Vomiting','ODK-VomitingEverything','ODK-ChestIndrawing','ODK-BPM1','FastBreathing1','ODK-BPM2','FastBreathing2','ODK-Unconscious','ODK-FeetSwelling','Cough','Fever','Diarrhea','Blood_in_stool','Convulsions','Unable_to_Eat_Anything','Vomiting_Everything','Chest_Indrawing','Sleepy_or_Unconcious','Feet_Swelling','Refer_Patient','Treat_Patient','FollowUp_Referral','ODK-DiarrheaTreatment1','ODK-DiarrheaTreatment2','ODK-DiarrheaTreatment3','ODK-Treatment_Fever1','ODK-Referral_Information1','ODK-Referral_Diarrhea1','ODK-Referral_Fever_1','ODK-Referral_Fever2','ODK-Referral_Fever_3','ODK-Referral_ChestIndrawing1','ODK-FollowUp_DangerSigns','ODK-FollowUp_Refer','ODK-FollowUp_Improvement','ODK-FollowUp_Refer2','ODK-Untreatable_Problem','ODK-Untreatable_Referral','ODK-NextDayFollowUp'];
                        var formName = 'FHW: Sick Child Form';
                        break;
                }
                
                // Create table headers
                var $myTable = $('#myTable');
                var myRow = "<tr>";
                for (j in nodeArray) {
                    myRow += "<th>" + nodeArray[j] + "</th>";
                }
                myRow += "</tr>";
                $myTable.append(myRow);
                
                // Get fileinput
                var myInput = document.getElementById('uploadInput');
                
                for(var i = 0; i < myInput.files.length ; i++) {
                    (function(i){
                        var file = myInput.files[i];
                        var reader = new FileReader();
                        reader.onload = function() {
                            
                            // Get string; parse into XML object
                            var filecontent = reader.result;
                            var myJQXML = $.parseXML(filecontent);
                            var $myJQXML = $(myJQXML);
                            
                            // Filter data; only display SCH or SST forms
                            if ( $myJQXML.find('data').attr('name') === formName ) {
                                
                                // Create table rows
                                myRow = "<tr>";
                                for (j in nodeArray) {
                                    myRow += "<td>" + $myJQXML.find(nodeArray[j]).text() + "</td>";
                                }
                                myRow += "</tr>";
                                $myTable.append(myRow);
                                
                            }
                            
                        }
                        reader.readAsText(file);
                    })(i);
                }

            });
            
            $('#downloadB').click(function(){
                
                var tableContents = $('#tableContents').html();
                
                // Construct the download link and programmatically click the link
                var textToWrite = tableContents;
                var textFileAsBlob = new Blob([textToWrite], {type: 'text/plain'});
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                var yyyy = today.getFullYear();
                var fileNameToSaveAs = "data_" + yyyy + "-" + mm + "-" + dd + ".xls"; // !!!!! make this a proper MySQL date (two digits for day and month) !!!!!
                var downloadLink = document.createElement("a");
                downloadLink.download = fileNameToSaveAs;
                downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
                downloadLink.click();
                
            });
            
        });
        </script>
        
    </head>
    
    <body id="myBody">
        
        <div id="myDiv">
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="SCH">SCH</div>
            <div style="float:left">&nbsp;&nbsp;<input type="radio" name="whichForm" value="SST">SST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
            <div style="float:left"><input id="uploadInput" type='file' multiple></div>
            <div style="float:left"><button id="uploadB" style="width:200px">Upload</button>&nbsp;&nbsp;</div>
            <div style="float:left"><button id="uploadODK" style="width:200px">Upload ODK</button>&nbsp;&nbsp;</div>
            <div style="float:left"><button id="downloadB" style="width:200px">Download as XLS</button></div>
            <br><hr>
            <div id="tableContents">
                <table><tbody id='myTable'></tbody></table>                
            </div>
            <div id="temp"></div>
        </div>
        
        
    </body>
    
</html>